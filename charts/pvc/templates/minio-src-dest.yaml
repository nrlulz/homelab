apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: {{ .Values.pvcName }}-volsync-minio
spec:
  secretStoreRef:
    name: bitwarden
    kind: ClusterSecretStore
  target:
    template:
      data:
        RESTIC_REPOSITORY: "s3:http://nas.internal:30188/volsync/{{ .Values.pvcName }}"
        RESTIC_PASSWORD: "{{ `{{ .RESTIC_PASSWORD }}` }}"
        AWS_ACCESS_KEY_ID: "{{ `{{ .AWS_ACCESS_KEY_ID }}` }}"
        AWS_SECRET_ACCESS_KEY: "{{ `{{ .AWS_SECRET_ACCESS_KEY }}` }}"
  data:
    - secretKey: RESTIC_PASSWORD
      remoteRef:
        key: VOLSYNC_RESTIC_PASSWORD
    - secretKey: AWS_ACCESS_KEY_ID
      remoteRef:
        key: VOLSYNC_LOCAL_ACCESS_KEY_ID
    - secretKey: AWS_SECRET_ACCESS_KEY
      remoteRef:
        key: VOLSYNC_LOCAL_SECRET_ACCESS_KEY

---
apiVersion: volsync.backube/v1alpha1
kind: ReplicationSource
metadata:
  name: {{ .Values.pvcName }}-volsync-minio-src
spec:
  sourcePVC: {{ .Values.pvcName }}
  trigger:
    schedule: {{ if eq .Values.triggerSchedule.minio "random" -}}
        {{- $triggerMinute := mod (randNumeric 2 | int64) 60 -}}
        {{- $triggerHour := mod (randNumeric 2 | int64) 24 -}}
        "{{ $triggerMinute }} {{ $triggerHour }} * * *"
      {{- else -}}
        {{ .Values.triggerSchedule.minio | quote }}
      {{- end }}
  restic:
    copyMethod: Snapshot
    pruneIntervalDays: 7
    repository: "{{ .Values.pvcName }}-volsync-minio"
    volumeSnapshotClassName: {{ .Values.volumeSnapshotClassName }}
    cacheCapacity: {{ .Values.cacheCapacity }}
    cacheStorageClassName: {{ .Values.cacheStorageClassName }}
    cacheAccessModes: {{ .Values.cacheAccessModes }}
    storageClassName: {{ .Values.replicationStorageClassName }}
    accessModes: {{ .Values.accessModes }}
    moverSecurityContext: {{ .Values.moverSecurityContext | toYaml | nindent 6 }}
    retain: {{ .Values.snapshotRetention | toYaml | nindent 6 }}

---
apiVersion: volsync.backube/v1alpha1
kind: ReplicationDestination
metadata:
  name: {{ .Values.pvcName }}-volsync-minio-dest
spec:
  trigger:
    manual: restore-once
  restic:
    repository: "{{ .Values.pvcName }}-volsync-minio"
    copyMethod: Snapshot # must be Snapshot
    volumeSnapshotClassName: {{ .Values.volumeSnapshotClassName }}
    cacheCapacity: {{ .Values.cacheCapacity }}
    cacheStorageClassName: {{ .Values.cacheStorageClassName }}
    cacheAccessModes: {{ .Values.cacheAccessModes }}
    storageClassName: {{ .Values.replicationStorageClassName }}
    accessModes: {{ .Values.accessModes }}
    capacity: {{ .Values.storageRequest }}
    moverSecurityContext: {{ .Values.moverSecurityContext | toYaml | nindent 6 }}
    cleanupCachePVC: true
    # cleanupTempPVC: true
