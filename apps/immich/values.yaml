pvc:
  pvcName: immich-data
  storageRequest: 64Gi
  moverSecurityContext:
    runAsUser: 1000
    runAsGroup: 1000

pgcluster:
  image: ghcr.io/tensorchord/cloudnative-vectorchord:18.0-0.5.3@sha256:267f6cbb32af6e109e138a143c7e9dd5d44d68433ec2303f0c30e745c788d1a9
  databaseName: immich
  generation: 2

  # ref: https://github.com/immich-app/immich-charts/blob/main/local/cloudnative-pg.yaml
  cluster:
    storage:
      size: 8Gi

    postgresql:
      shared_preload_libraries:
        - vchord.so

  initdb:
    postInitApplicationSQL:
      - CREATE EXTENSION vchord CASCADE;
      - CREATE EXTENSION earthdistance CASCADE;

immich:
  defaultPodOptions:
    securityContext:
      runAsNonRoot: true
      runAsUser: 1000
      runAsGroup: 1000
      fsGroupChangePolicy: OnRootMismatch

  controllers:
    main:
      annotations:
        reloader.stakater.com/auto: "true"
      containers:
        main:
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            readOnlyRootFilesystem: true
            seccompProfile:
              type: RuntimeDefault

  immich:
    persistence:
      library:
        existingClaim: immich-data

  valkey:
    enabled: true

  server:
    defaultPodOptions:
      securityContext:
        supplementalGroups:
          - 3003
          - 3004

    controllers:
      main:
        strategy: Recreate
        containers:
          main:
            image:
              repository: ghcr.io/immich-app/immich-server
              tag: v2.5.0@sha256:6c011eaa315b871f3207d68f97205d92b3e600104466a75b01eb2c3868e72ca1
            env:
              DB_URL:
                valueFrom:
                  secretKeyRef:
                    name: immich-cluster-v2-app
                    key: uri

    ingress:
      main:
        enabled: true
        className: external
        hosts:
          - host: photos.neils.house
            paths:
              - path: "/"
                service:
                  identifier: main

    persistence:
      photos:
        type: nfs
        server: nas.internal
        path: /mnt/data/photos
        globalMounts:
          - path: /mnt/data/photos
            readOnly: true
      photosync-emily:
        type: nfs
        server: nas.internal
        path: /mnt/data/photosync_emily
        globalMounts:
          - path: /mnt/data/photosync_emily
            readOnly: true
      photosync-neil:
        type: nfs
        server: nas.internal
        path: /mnt/data/photosync_neil
        globalMounts:
          - path: /mnt/data/photosync_neil
            readOnly: true

  machine-learning:
    controllers:
      main:
        containers:
          main:
            image:
              repository: ghcr.io/immich-app/immich-machine-learning
              tag: v2.5.0@sha256:5fee7f3e052c3d32d4edecafad68317394daae26f57d895fbd487886083725a7

    persistence:
      dotconfig:
        type: emptyDir
        globalMounts:
          - path: /.config
      dotcache:
        type: emptyDir
        globalMounts:
          - path: /.cache
      tmp:
        type: emptyDir
